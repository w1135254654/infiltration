
## 僵尸扫描概述

> 僵尸主机：僵尸主机是指感染僵尸程序病毒，从而被黑客程序控制的计算机设备。**但是僵尸扫描中的僵尸主机指得是一个闲置的操作系统（这里的闲置是指主机不会主动和任何人通信），且此系统中 `IP` 数据包中 `ID` 是递增的**。

`IPID`：指的是通信过中，`IP` 数据包中的 `ID`

> [!note|style:flat]
> 僵尸扫描拥有极高的隐蔽特性，但是实施条件苛刻


> 1. 目标网络可伪造源地址进行访问
> 
> 2. 选择僵尸机，僵尸机需要在互联网上是一个闲置的操作系统，需要系统使用递增的 `IPID`，比如XP 系统

`nmap` 和 `ping` 都会直接和目标机器接触。 如何可以不直接目标主机接触，还可以探测出目标主机是否开放端口？

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描概述/僵尸扫描概述.png" alt="僵尸扫描概述" align=center />

> [!tip|style:flat]
> 前提是：你在公网或局域网上先拿到了肉机。僵尸扫描可以不拿到肉机权限，只要对方的 `IPID` 是自增长上的就可以了。


## 僵尸扫描原理

### 端口开放状态扫描原理：

> **`TCP` 三次握手发包过程中，`SYN/ACK` 是第二次包。**

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描原理/TCP 三次握手发包过程.png" alt="TCP 三次握手发包过程" align=center />

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描原理/端口开放状态扫描原理.png" alt="端口开放状态扫描原理" align=center />

`zombie` <kbd>[ˈzɒmbi]</kbd> 僵尸


> - **第一步：参考图 1**
> 
>   1. 攻击者向僵尸机发送 `SYN/ACK` 确认包。
> 
>   2. 僵尸主机返回我们 `RST` 数据包关闭链接，`RST` 数据包中包含了 `IPID` 信息。假设 `IPID=X`
注：三次握手的第一个包是 `SYN`，目标主机收到 `SYN` 才会应答 `SYN/ACK`，因为僵尸主机没有向我们发送 `SYN` 请求。所以僵尸主机返回我们 `RST` 数据包关闭链接。
>
>      **第一步中，黑客的收获是：知道了僵尸主机的 `IPID`**
>
> - **第二步：参考图 2**
> 
>   1. 攻击者修改 `IP` 包头的 `SRC` 字段为僵尸主机的 `IP`，伪装成僵尸主机给目标主机发 `SYN` 请求。
>   
>   2. 目标主机收到请求，如果端口是开放的就会返回给僵尸主机一个 `SYN/ACK` 的数据包。
>   
>   3. 僵尸主机收到目标主机发来的 `SYN/ACK` 确认包，因为僵尸主机没有给你发 `SYN` 请求。所以僵尸主机给目标主机返回了一个 `RST` 数据包。这个数据包表示关闭连接。此僵尸主机对外发出一个数据包，所以僵尸主机的 `IPID` 值`+1`。此时 `IPID` 值为 `X+1`。
>
>      **第二步中，黑客的收获是：如果目标主机端口开放，让僵尸主机的 `IPID+1`**
>   
> - **第三步：参考图 3**
> 
>   1. 攻击者再次向僵尸主机发送 `SYN/ACK` 确认包
>   
>   2. 僵尸主机同样向攻击者返回了一个 `RST` 数据包，此僵尸主机对外又发出一个数据包，所以僵尸主机的 `IPID` 值再`+1`。此时 `IPID` 值为 `X+2`。
>   
> - **第四步：计算 `3` 次通信过中的 `IPID` 值**
> 
>   1. 攻击者查看僵尸主机返回的数据包中 `IPID` 值为 `X+2`。
>   
>   2. 攻击者对比在第一步中的 `IPID` 值 `X`，发现增加了 `2`。
>   
>      **结论：肯定目标主机和僵尸主机通信了，能通信，就说明目标主机端口是开放的。**


### 端口关闭状态扫描原理：

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描原理/端口关闭状态扫描原理.png" alt="端口关闭状态扫描原理" align=center />

> - **第一步：参考图 1**
> 
>   1. 攻击者向僵尸机发送 `SYN/ACK` 确认包。
> 
>   2. 僵尸主机返回我们 `RST` 数据包关闭链接，`RST` 数据包中包含了 `IPID` 信息。假设 `IPID=X`
注：三次握手的第一个包是 `SYN`，目标主机收到 `SYN` 才会应答 `SYN/ACK`，因为僵尸主机没有向我们发送 `SYN` 请求。所以僵尸主机返回我们 `RST` 数据包关闭链接。
>
> - **第二步：参考图 2**
> 
>   1. 攻击者修改 `IP` 包头的 `SRC` 字段为僵尸主机的 `IP`，伪装成僵尸主机给目标主机发 `SYN` 请求。
>   
>   2. 目标主机收到请求，如果端口是关闭的。就会返回给僵尸主机一个 `SYN/ACK` 的数据包。
>   
>   3. 僵尸主机收到目标主机发来的 `RST` 确认包，关闭链接不对外发送数据包。此僵尸主机的 `IPID` 值还是 `X`。
>      
> - **第三步：参考图 3**
> 
>   1. 攻击者再次向僵尸主机发送 `SYN/ACK` 确认包
>   
>   2. 僵尸主机同样向攻击者返回了一个 `RST` 数据包，此僵尸主机对外发出一个数据包，所以僵尸主机的 `IPID` 值`+1`。此时 `IPID` 值为 `X+1`。
>   
> - **第四步：计算 `3` 次通信过中的 `IPID` 值**
> 
>   1. 攻击者查看僵尸主机返回的数据包中 `IPID` 值为 `X+1`。
>   
>   2. 攻击者对比在第一步中的 `IPID` 值 `X`，发现增加了 `1`。
>   
>      **结论：肯定目标主机和僵尸主机没有通信了。没能通信，就说明目标主机端口是关闭的。以上就是僵尸扫描原理。**


## 僵尸扫描-实战

实验拓扑图:

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/僵尸扫描-实战实验拓扑图.png" alt="僵尸扫描-实战实验拓扑图" align=center />

一台 `XP` 的虚拟机为僵尸主机，`IP` 地址为 `192.168.1.54` 并关闭 `XP` 系统的防火墙`xuegod63` 为目标主机，`IP` 地址为 `192.168.1.63` 确认 `sshd` 服务能够正常访问。

`XP` 安装完后，要关闭防火墙：

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/关闭防火墙.png" alt="关闭防火墙" align=center />

###### 第一步：使用`Scapy`给僵尸主机发送的 `SYN/ACK` 数据包，将返回的数据包存入 `rz1`

```kali
参数说明：
rz1 表示定义了一个变量来接受我们返回的数据包
dst 表示我们的僵尸主机 IP
dport=445 表示我们向僵尸主机的 445 端口发送数据包，XP 主机的 445 端口一般都是开启状态
flags=“SA”表示发送 SYN/ACK

┌──(root㉿kali)-[~]
└─# scapy	# 先进入scapy工具

>>> rz1=sr1(IP(dst="192.168.1.54")/TCP(dport=445,flags="SA"))     # 向僵尸主机发送数据包

>>> rz1.display()
```

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/向僵尸主机发送数据包.png" alt="向僵尸主机发送数据包" align=center />

查看一下 `IPID`

`display()`表示查看变量中的内容。我们只需要查看 `IP` 下面的 `ID` 字段即可


###### 第二步：攻击者修改 `IP` 包头的 `SRC` 字段为僵尸主机的 `IP`，伪装成僵尸主机给目标主机发 `SYN` 请求

```kali
参数说明：
rt 表示定义了一个变量来接受我们返回的数据包
src 表示伪造成僵尸主机的 IP 地址
dst 表示将数据包发送目标主机
dport 目标端口
timeout 超时时间

>>> rt=sr1(IP(src="192.168.1.54",dst="192.168.1.63")/TCP(dport=22),timeout=1)     # 伪装成僵尸主机给目标主机发送数据包
```

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/伪装成僵尸主机给目标主机发送数据包.png" alt="伪装成僵尸主机给目标主机发送数据包" align=center />


###### 第三步：攻击者再次向僵尸主机发送 `SYN/ACK` 确认包，获得 `IPID`

```kali
rz2=sr1(IP(dst="192.168.1.54")/TCP(dport=445,flags="SA"))      # 再次向僵尸主机发送数据包，获得 IPID
```

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/再次向僵尸主机发送数据包.png" alt="再次向僵尸主机发送数据包" align=center />

###### 实验结果查看
`display()`表示查看变量中的内容。我们只需要查看 `IP` 下面的 `ID` 字段即可

```kali
>>> rz1.display()     # 查看rz1变量中IPID

>>> rz2.display()     # 查看rz2变量中IPID
```

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/查看rz1变量中IPID.png" alt="查看rz1变量中IPID" align=center />

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/查看rz2变量中IPID.png" alt="查看rz2变量中IPID" align=center />

即 `258-256=2` 表示端口开放

###### 我们测试端口不开放的情况，我们将第二步的端口修改成 `222` 因为 `222` 肯定是没有开启的端口

```kali
>>> rz1=sr1(IP(dst="192.168.1.54")/TCP(dport=445,flags="SA"))
>>> rt=sr1(IP(src="192.168.1.54",dst="192.168.1.63")/TCP(dport=222),timeout=1)
>>> rz2=sr1(IP(dst="192.168.1.54")/TCP(dport=445,flags="SA"))
>>> rz1.display()
>>> rz2.display()
```

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/测试端口不开放rz1变量.png" alt="测试端口不开放rz1变量" align=center />

<img src="assets/image/渗透测试系统Kali_Linux/实战-僵尸扫描/僵尸扫描-实战/测试端口不开放rz2变量.png" alt="测试端口不开放rz2变量" align=center />


