
## 被动信息收集

### 被动信息收集概述和目的


> 信息收集的方式可以分为两种：**被动**和**主动**。


> - 被动信息收集方式：**是指利用第三方的服务对目标进行访问了解**，比例：`Google 搜索`。
> - 主动的信息收集方式：**通过直接访问、扫描网站，这种将流量流经网站的行为**。比如：`nmap 扫描端口`。

> [!note|style:flat]
> **被动信息收集的目的**：通过公开渠道，去获得目标主机的信息，从而不与目标系统直接交互，避免留下痕迹。


### 信息收集内容

> 1. IP 地址段
> 2. 域名信息
> 3. 邮件地址
> 4. 文档图片数据
> 5. 公司地址
> 6. 公司组织架构
> 7. 联系电话 / 传真号码
> 8. 人员姓名 / 职务
> 9. 目标系统使⽤的技术架构
> 10. 公开的商业信息

### 信息用途

> 1. 信息描述目标
> 2. 发现目标
> 3. 社会工程学攻击
> 4. 物理缺口


## 通过 DNS 收集信息

### 域名解析原理

#### DNS 服务器概述

`DNS`（Domain Name Server，域名服务器）是进行域名(domain name)和与之相对应的 `IP` 地址 (IP address)转换的服务器。DNS 服务器分为**根域 `DNS` 服务器**、**顶级域名 `DNS` 服务器**。根域 DNS 服 务器有 13 个，都存储了全部的顶级域名服务器的所在地址


> 登录：https://wanwang.aliyun.com/ 买域名绑定到你的云主机上

> ICP备案查询：https://icplishi.com/ 

> 互联网域名系统北京市工程研究中心有限公司：https://icplishi.com/company/互联网域名系统北京市工程研究中心有限公司/

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/通过 DNS 收集信息/域名解析原理/DNS 服务器概述/万网域名注册.png" alt="万网域名注册" align=center />


#### 域名记录


> `A`，`Cname`，`NS`，`MX`，`PTR`


> **1. `A 记录（Address）`正向解析**
> 
> A 记录是将一个主机名（全称域名 FQDN）和一个 IP 地址关联起来。这也是大多数客户端程序默认 的查询类型。<br/>
> `例：xuegod.cn-> 8.8.8.6`
> 
> **2. `PTR 记录（Pointer）`反向解析** 
> 
> PTR 记录将一个 IP 地址对应到主机名（全称域名 FQDN）。这些记录保存在 in-addr.arpa 域中。
> 
> **3. `CNAME 记录(Canonical Name)`别名**
> 
> 别名记录，也称为规范名字(Canonical Name)。这种记录允许您将多个名字映射到同一台计算机。<br/>
> `例：www.xuegod.cn 对应 IP8.8.8.6`，`web.xuegod.cn 对应 IP8.8.8.6`
> 
> **4. `MX 记录（Mail eXchange）`** 
> 
> MX 记录是邮件交换记录，它指向一个邮件服务器，用于电子邮件系统发邮件时根据 收信人的地址后 缀来定位邮件服务器。
> `例：mail.xuegod.cn`<br/>
> 当有多个 MX 记录（即有多个邮件服务器）时，则需要设置数值来确定其优先级。通过设置优先级数 字来指明首选服务器，数字越小表示优先级越高。
> 
> **5. `NS 记录（Name Server）`**
> 
> NS（Name Server）记录是域名服务器记录，也称为授权服务器，用来指定该域名由哪个 DNS 服 务器来进行解析。 
> `例：dns.xuegod.cn`


#### DNS 缓存服务器


> **缓存 DNS 服务器**：不负责解析域，只是缓存域名解析结果。


#### DNS 查询过程

一个 `DNS` 查询过程，通过 8 个步骤的解析过程就使得客户端可以顺利访问 www.163.com 这个域名， 但实际应用中，通常这个过程是非常迅速的

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/通过 DNS 收集信息/域名解析原理/DNS 查询过程/DNS 查询过程.png" alt="万网域名注册" align=center />


DNS 查询过程文档化


> 1. **浏览器缓存**:当用户通过浏览器访问某域名时，浏览器首先会在自己的缓存中查找是否有该域名对 应的 IP 地址（若曾经访问过该域名且没有清空缓存便存在）
> 
> 2. **系统缓存**:当浏览器缓存中无域名对应 IP 则会自动检查用户计算机系统 Hosts 文件 DNS 缓存是 否有该域名对应 IP
> 
> 3. **路由器缓存**:当浏览器及系统缓存中均无域名对应 IP 则进入路由器缓存中检查，以上三步均为客户 端的 DNS 缓存
> 
> 4. **ISP（互联网服务提供商）DNS 缓存(一般就是本地 DNS 服务器)**:当在用户客户端查找不到域名 对应 IP 地址，则将进入 ISP DNS 缓存中进行查询。比如你用的是电信的网络，则会进入电信的 DNS 缓 存服务器中进行查找
> 
> 5. **根域名服务器**：当以上均未完成，则进入根服务器进行查询。全球仅有 13 台根域名服务器，1 个 主根域名服务器，其余 12 为辅根域名服务器。根域名收到请求后会查看区域文件记录，若无则将其管辖 范围内顶级域名（如.com）服务器 IP 告诉本地 DNS 服务器
> 
> 6. **顶级域名服务器**：顶级域名服务器收到请求后查看区域文件记录，若无则将其管辖范围内主域名服务器的 IP 地址告诉本地 DNS 服务器
> 
> 7. **主域名服务器**：主域名服务器接受到请求后查询自己的缓存，如果没有则进入下一级域名服务器进行查找，并重复该步骤直至找到正确纪录
> 
> 8. **保存结果至缓存**：本地域名服务器把返回的结果保存到缓存，以备下一次使用，同时将该结果反馈给客户端，客户端通过这个 IP 地址与 web 服务器建立链接


#### DNS 查询方式： 

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/通过 DNS 收集信息/域名解析原理/DNS 查询方式/DNS 查询方式.png" alt="DNS 查询方式" align=center />

----------

`递归查询`：主机向本地域名服务器的查询一般都是采用递归查询。


> **递归查询**：客户端只发一次请求，要求对方给出最终结果。

----------

`迭代查询`：本地域名服务器向根域名服务器的查询的迭代查询。


> **迭代查询**：客户端发出一次请求，对方如果没有授权回答，它就会返回一个能解答这个查询的其它名称服务器列表，客户端会再向返回的列表中发出请求，直到找到最终负责所查域名的名称服务器，从它得到最终结果。


## Kali信息收集实战

### DNS 信息收集

#### 将域名解析为 IP 地址

```kali
┌──(root�xuegod53)-[~] 
└─# ping 12306.cn

PING 12306.cn.wsglb0.com (103.254.188.41) 56(84) bytes of data. 64 bytes from 
103.254.188.41 (103.254.188.41): icmp_seq=1 ttl=57 time=5.78 ms 64 bytes from
103.254.188.41 (103.254.188.41): icmp_seq=2 ttl=57 time=7.25 ms 64 bytes from
103.254.188.41 (103.254.188.41): icmp_seq=3 ttl=57 time=5.67 ms
```

#### 使用 `nslookup` 查看域名

**例1**：查看12306ip
```kali
┌──(root�xuegod53)-[~]
└─# nslookup 12306.cn

Server: 114.114.114.114 	#DNS 服务器 
Address: 114.114.114.114#53 #DNS 服务器地址 

Non-authoritative answer: 		#非权威性回答 
12306.cn canonical name = 12306.cn.wsglb0.com. 	#12306.cn 域名的别名 
Name:   12306.cn.wsglb0.com
Address: 111.206.105.194
Name:   12306.cn.wsglb0.com
Address: 111.206.176.78			#12306.cn 解析出来的 IP
```

**例2**：查看百度ip
```kali
┌──(root㉿kali)-[~]
└─# nslookup baidu.com

Server:         114.114.114.114
Address:        114.114.114.114#53

Non-authoritative answer:
Name:   baidu.com
Address: 220.181.38.148
Name:   baidu.com
Address: 220.181.38.251
```

#### `DIG`-信息收集

```kali
语法： 
dig 	(选项) 		需要查询的域名 
		@<DNS 服务器地址>： 指定进行域名解析的域名服务器； 
		any #显示所有类型的域名记录。默认只显示 A 记录
```

**语法例1：直接通过域名获取信息**
```kali
┌──(root㉿kali)-[~]
└─# dig 12306.cn

; <<>> DiG 9.18.0-2-Debian <<>> 12306.cn
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 23434
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;12306.cn.                      IN      A

;; ANSWER SECTION:
12306.cn.               3063    IN      CNAME   12306.cn.wsglb0.com.
12306.cn.wsglb0.com.    47      IN      A       111.206.105.194
12306.cn.wsglb0.com.    47      IN      A       111.206.176.78

;; Query time: 23 msec
;; SERVER: 114.114.114.114#53(114.114.114.114) (UDP)
;; WHEN: Sat Jun 18 11:14:27 EDT 2022
;; MSG SIZE  rcvd: 102
```

**语法例2：指定进行域名解析的域名服务器查询信息**
```kali
┌──(root㉿kali)-[~]
└─# dig @114.114.114.114 12306.cn

; <<>> DiG 9.18.0-2-Debian <<>> @114.114.114.114 12306.cn
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10630
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;12306.cn.                      IN      A

;; ANSWER SECTION:
12306.cn.               2786    IN      CNAME   12306.cn.wsglb0.com.
12306.cn.wsglb0.com.    34      IN      A       111.206.105.194
12306.cn.wsglb0.com.    34      IN      A       111.206.176.78

;; Query time: 20 msec
;; SERVER: 114.114.114.114#53(114.114.114.114) (UDP)
;; WHEN: Sat Jun 18 11:19:04 EDT 2022
;; MSG SIZE  rcvd: 102
```

**语法例3：显示所有类型的域名记录查询信息**
```kali
┌──(root㉿kali)-[~]
└─# dig @114.114.114.114 any 12306.cn

; <<>> DiG 9.18.0-2-Debian <<>> @114.114.114.114 any 12306.cn
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 45117
;; flags: qr rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;12306.cn.                      IN      ANY

;; ANSWER SECTION:
12306.cn.               2876    IN      NS      cns1.zdnscloud.net.
12306.cn.               2876    IN      NS      ins1.zdnscloud.com.
12306.cn.               2876    IN      NS      dns1.zdnscloud.info.
12306.cn.               2876    IN      NS      vns1.zdnscloud.biz.
12306.cn.               2579    IN      CNAME   12306.cn.wsglb0.com.

;; Query time: 256 msec
;; SERVER: 114.114.114.114#53(114.114.114.114) (TCP)
;; WHEN: Sat Jun 18 11:22:31 EDT 2022
;; MSG SIZE  rcvd: 196
```

**语法例4：使用`-x` 参数 IP 反查域名**
```kali
┌──(root㉿kali)-[~]
└─# dig -x 114.114.114.114           

; <<>> DiG 9.18.0-2-Debian <<>> -x 114.114.114.114
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 13909
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;114.114.114.114.in-addr.arpa.  IN      PTR

;; ANSWER SECTION:
114.114.114.114.in-addr.arpa. 383 IN    PTR     public1.114dns.com.

;; Query time: 20 msec
;; SERVER: 114.114.114.114#53(114.114.114.114) (UDP)
;; WHEN: Sat Jun 18 23:11:10 EDT 2022
;; MSG SIZE  rcvd: 89
```

**语法例5：`114.114.114.114` 反向解析为 `public1.114dns.com`**
```kali
┌──(root㉿kali)-[~]
└─# ping public1.114dns.com
PING public1.114dns.com (114.114.114.114) 56(84) bytes of data.
64 bytes from public1.114dns.com (114.114.114.114): icmp_seq=1 ttl=128 time=27.5 ms
64 bytes from public1.114dns.com (114.114.114.114): icmp_seq=2 ttl=128 time=19.3 ms
64 bytes from public1.114dns.com (114.114.114.114): icmp_seq=3 ttl=128 time=18.5 ms
^C
--- public1.114dns.com ping statistics ---
3 packets transmitted, 3 received, 0% packet loss, time 1998ms
rtt min/avg/max/mdev = 18.538/21.771/27.458/4.033 ms
```

**语法例6：查询 DNS 服务器 bind 版本信息**

> <span style='color: red'>查询 DNS 版本信息的目的：可以通过版本信息来查找相关版本漏洞的利用方式</span>

**语法说明：**

| 记录类型 | 类级别   | 版本信息   | 域名服务器						   |
| :------: | :-----: | :-------: | :-----------------------------: |
| `txt`    | `chaos` | `version` | `@ns3.dnsv4.com` `<@域名服务器>` |

```kali
┌──(root㉿kali)-[~]
└─# dig txt chaos version.bing @ns3.dnsv4.com                      

; <<>> DiG 9.18.0-2-Debian <<>> txt chaos version.bing @ns3.dnsv4.com
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: REFUSED, id: 39506
;; flags: qr rd ad; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1
;; WARNING: recursion requested but not available

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; COOKIE: 3660c39ee2bd88d7 (echoed)
;; QUESTION SECTION:
;version.bing.                  CH      TXT	 "1.1.1711.01" 	#这是软件包版本信息

;; Query time: 16 msec
;; SERVER: 162.14.25.247#53(ns3.dnsv4.com) (UDP)
;; WHEN: Sun Jun 19 04:09:09 EDT 2022
;; MSG SIZE  rcvd: 53

```


#### 查询网站的域名注册信息和备案信息

域名注册信息的两种查询方式， **`Web` 接口查询和 `Whois` 命令查询**

##### `Whois` 命令查询

```kali
┌──(root㉿kali)-[~]
└─# whois 12306.cn

Domain Name: 12306.cn
ROID: 20030310s10001s00012731-cn
Domain Status: serverDeleteProhibited
Domain Status: serverUpdateProhibited
Domain Status: serverTransferProhibited
Registrant: 中国铁道科学研究院集团有限公司
Registrant Contact Email: 13501238352@139.com
Sponsoring Registrar: 北京中科三方网络技术有限公司
Name Server: cns1.zdnscloud.net
Name Server: dns1.zdnscloud.info
Name Server: ins1.zdnscloud.com
Name Server: vns1.zdnscloud.biz
Registration Time: 2003-03-10 18:50:16
Expiration Time: 2029-01-13 14:16:31
DNSSEC: unsigned
```

##### 通过 Web 接口查询

阿里云：https://whois.aliyun.com/

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/Kali 信息收集实战/DNS 信息收集/查询网站的域名注册信息和备案信息/通过 Web 接口查询/域名查询网站.png" alt="域名查询网站" align=center />

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/Kali 信息收集实战/DNS 信息收集/查询网站的域名注册信息和备案信息/通过 Web 接口查询/查询域名信息.png" alt="查询域名信息" align=center />

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/Kali 信息收集实战/DNS 信息收集/查询网站的域名注册信息和备案信息/通过 Web 接口查询/域名英文注册信息.png" alt="域名英文注册信息" align=center />


站长之家：http://whois.chinaz.com/

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/Kali 信息收集实战/DNS 信息收集/查询网站的域名注册信息和备案信息/通过 Web 接口查询/站长之家查询域名信息.png" alt="站长之家查询域名信息" align=center />


##### 备案信息查询

##### Web 接口查询

站长之家备案信息：http://icp.chinaz.com/

爱站网：https://icp.aizhan.com/

工业和信息化部：https://beian.miit.gov.cn/#/Integrated/index

<img src="assets/image/渗透测试系统Kali_Linux/利用第三方服务对目标进行被动信息收集防止被发现/Kali 信息收集实战/DNS 信息收集/查询网站的域名注册信息和备案信息/通过 Web 接口查询/站长之家备案信息.png" alt="站长之家备案信息" align=center />


天眼查：https://www.tianyancha.com/

